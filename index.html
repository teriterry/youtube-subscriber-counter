<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>YouTube チャンネル登録者数</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="./css/rolling-counter.css" />
    <link rel="stylesheet" href="./style.css" />

</head>

<body>
    <button id="loginBtn">Google にログインして登録者数を表示</button>
    <!-- <div id="subscriberCount">読み込み中...</div> -->
    <div class="stats-container">
        <div class="counter" id="subscriberCount"></div>

        <div class="div1"></div>
        <div class="div2"></div>
        <div class="div3"></div>
        <div class="div4"></div>
        <div class="div5"></div>

    </div>

    <script type="module">
        import { RollingCounter } from './js/rolling-counter.js';
        const subsCounter = new RollingCounter('#subscriberCount', 0);

        const CLIENT_ID = '447703056009-5u9n18137gdlknbd5ds1rhr4h6rt4ifs.apps.googleusercontent.com';
        const REDIRECT_URI = window.location.href.split('#')[0];
        const REFRESH_INTERVAL = 30000; // ← ここで30秒に設定

        function getAccessTokenFromUrl() {
            const hashParams = new URLSearchParams(window.location.hash.substr(1));
            return hashParams.get('access_token');
        }

        async function getSubscriberCount(token) {
            try {
                const response = await fetch('https://www.googleapis.com/youtube/v3/channels?part=statistics&mine=true', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const data = await response.json();
                // console.log("📦 データ取得:", data);

                if (!response.ok || !data.items || data.items.length === 0) {
                    $('#subscriberCount').text('登録者数を取得できませんでした。再度ログインしてください。');
                    return;
                }

                const count = data.items[0].statistics.subscriberCount;
                // $('#subscriberCount').text(`登録者数：${count}`);
                subsCounter.update(`${count}`);

            } catch (err) {
                console.error("⚠️ エラー:", err);
                $('#subscriberCount').text('エラーが発生しました。');
            }
        }

        $(document).ready(function () {
            const token = getAccessTokenFromUrl();
            //   console.log("🔑 アクセストークン:", token);

            if (token) {
                $('#loginBtn').hide();
                getSubscriberCount(token);
                setInterval(() => getSubscriberCount(token), REFRESH_INTERVAL); // ← ここで30秒ごとに更新
            }

            $('#loginBtn').on('click', function () {
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${CLIENT_ID}&` +
                    `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                    `response_type=token&` +
                    `scope=https://www.googleapis.com/auth/youtube.readonly&` +
                    `include_granted_scopes=true`;

                window.location.href = authUrl;
            });
        });
    </script>
</body>

</html>